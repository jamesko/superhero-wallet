<template>
  <div class="auction-bid">
    <AuctionOverview :name="name" />
    <div class="form">
      <AmountInput
        v-model="amount"
        :error="!!amountError"
        :error-message="amountError"
      />
      <div class="tx-details">
        <DetailsItem
          :label="$t('tx-fee')"
          hide-fiat
        >
          <TokenAmount
            slot="value"
            :amount="+txFee"
          />
        </DetailsItem>
        <DetailsItem :label="$t('total')">
          <TokenAmount
            slot="value"
            :amount="+amountTotal"
          />
        </DetailsItem>
      </div>
      <Button
        :disabled="!!amountError || !+amount"
        @click="bid"
      >
        {{ $t('pages.names.auctions.place-bid') }}
      </Button>
    </div>
    <Loader v-if="loading" />
  </div>
</template>

<script>
import { mapGetters } from 'vuex';
import { aeToAettos } from '../../../utils/helper';
import { calculateNameClaimFee } from '../../../utils/constants';
import AuctionOverview from '../../components/AuctionOverview';
import AmountInput from '../../components/AmountInput';
import DetailsItem from '../../components/DetailsItem';
import TokenAmount from '../../components/TokenAmount';
import Button from '../../components/Button';

export default {
  components: {
    AuctionOverview, AmountInput, DetailsItem, TokenAmount, Button,
  },
  props: {
    name: { type: String, required: true },
  },
  data() {
    return {
      loading: false,
      amount: 0,
      amountError: null,
    };
  },
  computed: {
    ...mapGetters('names', ['getHighestBid']),
    highestBid() {
      return this.getHighestBid(this.name).nameFee;
    },
    txFee() {
      return calculateNameClaimFee(this.name);
    },
    amountTotal() {
      return this.txFee.plus(this.amount || 0);
    },
  },
  watch: {
    amount(val) {
      if (!+val) {
        this.amountError = this.$t('pages.names.auctions.add-amount');
      } else if (+val <= this.highestBid.multipliedBy(1.05)) {
        const minBid = this.highestBid.multipliedBy(1.05).toString();
        this.amountError = this.$t('pages.names.auctions.min-bid', { minBid });
      } else {
        this.amountError = '';
      }
    },
  },
  methods: {
    async bid() {
      await this.$watchUntilTruly(() => this.$store.state.sdk);
      if (this.amountError) return;
      this.loading = true;
      try {
        await this.$store.state.sdk.aensBid(this.name, aeToAettos(this.amount));
        this.$store.dispatch('modals/open', {
          name: 'default',
          msg: this.$t('pages.names.auctions.bid-added', { name: this.name }),
        });
        this.$router.push({ name: 'auction-history', params: { name: this.name } });
      } catch (e) {
        let msg = e.message;
        if (msg.includes('is not enough to execute')) {
          msg = this.$t('pages.names.balance-error');
        }
        this.$store.dispatch('modals/open', { name: 'default', msg });
      } finally {
        this.loading = false;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
@use '../../../../styles/variables';

.auction-bid {
  .form {
    padding: 16px;

    .tx-details {
      display: flex;
      padding-top: 16px;

      .details-item {
        margin-right: 24px;
      }
    }

    .button {
      margin-top: 16px;
    }
  }
}
</style>
